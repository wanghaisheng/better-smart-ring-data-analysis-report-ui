<html><head><base href="https://domain.xyz/" />
<style>
:root {
  --primary: #2B5F75;
  --secondary: #48A1C3;
  --accent: #FFB26B;
  --text: #333;
  --bg: #F5F9FA;
}

body {
  font-family: 'Segoe UI', sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
  margin: 0;
  padding: 20px;
}

.container {
  max-width: 1000px;
  margin: 0 auto;
  background: white;
  border-radius: 15px;
  padding: 30px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.header {
  text-align: center;
  margin-bottom: 40px;
  color: var(--primary);
}

.sleep-score {
  display: flex;
  justify-content: center;
  align-items: center;
  margin: 30px 0;
}

.score-circle {
  width: 200px;
  height: 200px;
  position: relative;
}

.chart-container {
  margin: 30px 0;
  padding: 20px;
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin: 30px 0;
}

.stat-card {
  background: white;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  transition: transform 0.3s ease;
}

.stat-card:hover {
  transform: translateY(-5px);
}

.insight-card {
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: white;
  padding: 20px;
  border-radius: 10px;
  margin: 20px 0;
}

.recommendation {
  background: #fff;
  border-left: 4px solid var(--accent);
  padding: 15px;
  margin: 10px 0;
  transition: transform 0.2s ease;
}

.recommendation:hover {
  transform: translateX(5px);
}

.trends-section {
  background: white;
  padding: 20px;
  border-radius: 10px;
  margin: 20px 0;
}

.baseline-comparison {
  background: white;
  padding: 20px;
  border-radius: 10px;
  margin: 20px 0;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.correlation-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin: 20px 0;
}

.correlation-item {
  background: linear-gradient(135deg, rgba(43, 95, 117, 0.1), rgba(72, 161, 195, 0.1));
  padding: 15px;
  border-radius: 8px;
  border: 1px solid var(--secondary);
}

.baseline-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 20px;
  margin: 20px 0;
}

.baseline-card {
  background: white;
  padding: 15px;
  border-radius: 8px;
  border-left: 4px solid var(--secondary);
}

/* New section styles */
.success-highlight {
  border-left: 4px solid var(--accent);
  padding: 20px;
  margin: 20px 0;
  background: rgba(255, 178, 107, 0.1);
  transition: all 0.3s ease;
}

.success-highlight:hover {
  transform: scale(1.02);
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.success-highlight h3 {
  color: var(--primary);
  margin-bottom: 15px;
}

.success-highlight ul {
  list-style-type: none;
  padding-left: 0;
}

.success-highlight ul li {
  margin: 10px 0;
  padding-left: 25px;
  position: relative;
}

.success-highlight ul li:before {
  content: "âœ“";
  color: var(--accent);
  position: absolute;
  left: 0;
}

/* New styles */
.fact-section, .feeling-section, .future-section {
  margin: 20px 0;
  padding: 15px;
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.8);
}

.fact-section h4, .feeling-section h4, .future-section h4 {
  color: var(--primary);
  margin-bottom: 10px;
}

.fact-section ul, .feeling-section ul, .future-section ul {
  list-style-type: none;
  padding-left: 0;
}

.fact-section ul li, .feeling-section ul li, .future-section ul li {
  margin: 8px 0;
  padding-left: 25px;
  position: relative;
}

.fact-section ul li:before {
  content: "ğŸ“Š";
  position: absolute;
  left: 0;
}

.feeling-section ul li:before {
  content: "ğŸ’«";
  position: absolute;
  left: 0;
}

.future-section ul li:before {
  content: "ğŸ¯";
  position: absolute;
  left: 0;
}

/* Animation */
@keyframes fillCircle {
  from { stroke-dasharray: 0 283; }
  to { stroke-dasharray: 200 283; }
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.fade-in {
  animation: fadeIn 0.8s ease-out forwards;
}

.positive-trends {
  background: white;
  padding: 20px;
  border-radius: 10px;
  margin: 20px 0;
}

.details-button {
  background: var(--secondary);
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 5px;
  cursor: pointer;
  margin: 10px 0;
  transition: all 0.3s ease;
}

.details-button:hover {
  background: var(--primary);
  transform: translateY(-2px);
}

.chart-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.8);
  z-index: 1000;
  justify-content: center;
  align-items: center;
}

.chart-modal-content {
  background: white;
  padding: 20px;
  border-radius: 10px;
  width: 80%;
  max-width: 800px;
  max-height: 80vh;
  overflow-y: auto;
  position: relative;
}

.close-modal {
  position: absolute;
  right: 15px;
  top: 15px;
  font-size: 24px;
  cursor: pointer;
  color: var(--text);
}

.highlight-point {
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.5); opacity: 0.7; }
  100% { transform: scale(1); opacity: 1; }
}

.annotation-label {
  background: var(--accent);
  color: white;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 12px;
}

.chart-controls {
  margin-bottom: 20px;
  display: flex;
  gap: 10px;
}

.trend-toggle {
  padding: 8px 16px;
  border: 1px solid var(--secondary);
  background: white;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.trend-toggle.active {
  background: var(--secondary);
  color: white;
}

.data-interaction {
  margin-top: 20px;
  padding: 15px;
  background: #f5f5f5;
  border-radius: 8px;
}

.interaction-controls {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
}

.data-notes {
  max-height: 200px;
  overflow-y: auto;
}

.prep-section {
  padding: 25px;
  margin: 20px 0;
  background: white;
  border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.prep-point {
  color: var(--primary);
  font-size: 1.2em;
  font-weight: bold;
  margin-bottom: 15px;
  padding-left: 15px;
  border-left: 4px solid var(--accent);
}

.prep-reason {
  margin: 15px 0;
  color: var(--text);
}

.prep-example {
  background: rgba(72, 161, 195, 0.1);
  padding: 15px;
  border-radius: 8px;
  margin: 15px 0;
}

.prep-final {
  font-weight: 500;
  color: var(--primary);
  margin-top: 15px;
  padding-top: 15px;
  border-top: 1px solid #eee;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
</head>
<body>

<div class="container">
  <!-- Header Section -->
  <div class="header fade-in">
    <h1>ç¡çœ å¥åº·æ´å¯ŸæŠ¥å‘Š</h1>
    <p>çº¦ç¿°çš„ä¸ªäººç¡çœ åˆ†æ | 2024å¹´2æœˆ</p>
  </div>

  <div class="sleep-score fade-in">
    <svg class="score-circle" viewBox="0 0 100 100">
      <circle cx="50" cy="50" r="45" fill="none" stroke="#eee" stroke-width="5"/>
      <circle cx="50" cy="50" r="45" fill="none" stroke="var(--accent)" 
              stroke-width="5" stroke-dasharray="200 283" 
              style="animation: fillCircle 1.5s ease-out">
      </circle>
      <text x="50" y="45" text-anchor="middle" font-size="20" fill="var(--primary)">85</text>
      <text x="50" y="60" text-anchor="middle" font-size="8" fill="var(--primary)">ä¼˜ç§€</text>
    </svg>
  </div>

  <div class="stats-grid fade-in">
    <div class="stat-card">
      <h3>å¹³å‡ç¡çœ æ—¶é•¿</h3>
      <p>7.3 å°æ—¶</p>
      <small>å»ºè®®ï¼š7-9 å°æ—¶</small>
    </div>
    <div class="stat-card">
      <h3>æ·±åº¦ç¡çœ æ¯”ä¾‹</h3>
      <p>25%</p>
      <small>é«˜äºåŒé¾„äººå¹³å‡æ°´å¹³</small>
    </div>
    <div class="stat-card">
      <h3>ç¡çœ è§„å¾‹æ€§</h3>
      <p>90%</p>
      <small>ä½œæ¯éå¸¸è§„å¾‹</small>
    </div>
  </div>

  <div class="positive-trends fade-in">
    <h3>ğŸŒŸ ç§¯æè¡¨ç°åˆ†æ</h3>
    <div class="success-highlight">
      <div class="fact-section">
        <h4>äº‹å®ï¼šæ‚¨çš„æˆå°±</h4>
        <ul>
          <li>æŒç»­ä¿æŒ7.3å°æ—¶ç¡çœ </li>
          <li>25%æ·±åº¦ç¡çœ æ¯”ä¾‹ - é«˜äºå¹³å‡</li>
          <li>90%ç¡çœ æ—¶é—´è§„å¾‹æ€§</li>
        </ul>
      </div>
      
      <div class="feeling-section">
        <h4>å½±å“ï¼šæ˜¾è‘—ç›Šå¤„</h4>
        <ul>
          <li>æ—¥å¸¸èƒ½é‡æ°´å¹³æå‡</li>
          <li>æ”¹å–„å¿ƒæ™ºæ¸…æ™°åº¦å’Œä¸“æ³¨åŠ›</li>
          <li>æ›´å¥½çš„å‹åŠ›ç®¡ç†èƒ½åŠ›</li>
        </ul>
      </div>
      
      <div class="future-section">
        <h4>æœªæ¥ï¼šæˆé•¿æ½œåŠ›</h4>
        <ul>
          <li>æ­£åœ¨è¿ˆå‘æœ€ä½³ç¡çœ å¥åº·</li>
          <li>å»ºç«‹å¯æŒç»­çš„å¥åº·ä¹ æƒ¯</li>
          <li>å…·å¤‡æŒç»­æ”¹è¿›çš„æ¡ä»¶</li>
        </ul>
      </div>
    </div>
  </div>

  <div class="chart-container fade-in">
    <canvas id="sleepTrendChart"></canvas>
  </div>

  <div class="prep-section fade-in">
    <div class="prep-point">
      æ‚¨çš„ç¡çœ è´¨é‡æœ¬æœˆæ˜¾è‘—æå‡
    </div>
    
    <div class="prep-reason">
      å¤šä¸ªå…³é”®æŒ‡æ ‡æ˜¾ç¤ºæ‚¨çš„ç¡çœ æ¨¡å¼å‘ˆç°ç§¯æè¶‹åŠ¿ï¼š
      <ul>
        <li>æ·±åº¦ç¡çœ æ—¶é•¿å¢åŠ 15%</li>
        <li>ç¡çœ ä¸€è‡´æ€§æå‡20%</li>
        <li>å…¥ç¡æ—¶é—´ç¼©çŸ­10åˆ†é’Ÿ</li>
      </ul>
    </div>
    
    <div class="prep-example">
      <h4>çªå‡ºæ¡ˆä¾‹ï¼š</h4>
      <ul>
        <li>è¿åŠ¨æ—¥ï¼šæ·±åº¦ç¡çœ è¾¾åˆ°25%ï¼ˆåŸºå‡†å€¼20%ï¼‰</li>
        <li>è§„å¾‹å°±å¯æ—¶é—´ï¼ˆæ™šä¸Š10:30ï¼‰ï¼šç¡çœ è´¨é‡å¾—åˆ†85/100</li>
        <li>å‘¨æœ«æ¢å¤ï¼šè¾¾åˆ°7.5+å°æ—¶ä¼˜è´¨ç¡çœ </li>
      </ul>
    </div>
    
    <div class="prep-final">
      ä¿æŒè¿™äº›è‰¯å¥½çš„ç¡çœ ä¹ æƒ¯å°†ç»§ç»­æå‡æ‚¨çš„æ•´ä½“ç¡çœ å¥åº·å’Œæ—¥å¸¸è¡¨ç°ã€‚
    </div>
  </div>

  <div class="trends-section fade-in">
    <h3>ğŸ“Š ç¡çœ è¶‹åŠ¿åˆ†æ</h3>
    <p>ç¡çœ æ—¶é•¿åœ¨è¿‡å»ä¸€å‘¨ä¿æŒç¨³å®šï¼ŒèŒƒå›´åœ¨6.8-7.6å°æ—¶ä¹‹é—´ã€‚å‘¨æœ«ç¨é•¿çš„ç¡çœ æœ‰åŠ©äºå‡å°‘å·¥ä½œæ—¥ç´¯ç§¯çš„ç–²åŠ³ã€‚</p>
    <button class="details-button" onclick="showDetailModal('sleep-quality')">
      æŸ¥çœ‹è¯¦ç»†è¶‹åŠ¿
    </button>
  </div>

  <div class="baseline-comparison fade-in">
    <h3>ğŸ¯ åŸºå‡†æ¯”è¾ƒåˆ†æ</h3>
    <div class="baseline-grid">
      <div class="baseline-card">
        <h4>ä¸ªäººåŸºå‡†</h4>
        <p>è¿‡å»3ä¸ªæœˆçš„å¹³å‡ï¼š</p>
        <ul>
          <li>ç¡çœ æ—¶é•¿ï¼š7.1å°æ—¶ï¼ˆå½“å‰ +0.2å°æ—¶ï¼‰</li>
          <li>å°±å¯æ—¶é—´ï¼šæ™šä¸Š11:30ï¼ˆå½“å‰æ—©15åˆ†é’Ÿï¼‰</li>
          <li>æ·±åº¦ç¡çœ ï¼š22%ï¼ˆå½“å‰ +3%ï¼‰</li>
        </ul>
      </div>
      <div class="baseline-card">
        <h4>äººç¾¤åŸºå‡†</h4>
        <p>åŒé¾„äººï¼ˆ30-35å²ï¼‰å¹³å‡ï¼š</p>
        <ul>
          <li>ç¡çœ æ—¶é•¿ï¼š6.9å°æ—¶ï¼ˆæ‚¨ +0.4å°æ—¶ï¼‰</li>
          <li>å°±å¯æ—¶é—´ï¼šæ™šä¸Š11:45ï¼ˆæ‚¨æ—©15åˆ†é’Ÿï¼‰</li>
          <li>æ·±åº¦ç¡çœ ï¼š20%ï¼ˆæ‚¨ +5%ï¼‰</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Correlation Section -->
  <div class="correlation-section fade-in">
    <h3>ğŸ”„ ç»¼åˆç›¸å…³æ€§åˆ†æ</h3>
    
    <h4>è¡Œä¸ºå› ç´ </h4>
    <div class="correlation-grid">
      <div class="correlation-item">
        <h4>è¿åŠ¨å½±å“</h4>
        <p>è¿åŠ¨æ—¥æ·±åº¦ç¡çœ å¢åŠ 18%</p>
        <p>é™æ¯å¿ƒç‡ä¸‹é™3-5 bpm</p>
        <p>ç›¸å…³æ€§ï¼š0.82ï¼ˆå¼ºï¼‰</p>
      </div>
      <div class="correlation-item">
        <h4>é¥®é£Ÿä¹ æƒ¯</h4>
        <p>åœ¨æ™šé¤å3å°æ—¶å†…ç¡è§‰çš„å½±å“ï¼š</p>
        <ul>
          <li>å°±å¯æ—¶é—´å»¶è¿Ÿ15åˆ†é’Ÿ</li>
          <li>æ·±åº¦ç¡çœ è´¨é‡ä¸‹é™8%</li>
        </ul>
        <p>ç›¸å…³æ€§ï¼š-0.65ï¼ˆä¸­åº¦è´Ÿç›¸å…³ï¼‰</p>
      </div>
      <div class="correlation-item">
        <h4>å·¥ä½œå‹åŠ›</h4>
        <p>é«˜å‹åŠ›å·¥ä½œæ—¥çš„è¡¨ç°ï¼š</p>
        <ul>
          <li>ç¡çœ è´¨é‡ä¸‹é™12%</li>
          <li>å¿ƒç‡å˜å¼‚æ€§ä¸‹é™15%</li>
        </ul>
        <p>ç›¸å…³æ€§ï¼š-0.78ï¼ˆå¼ºè´Ÿç›¸å…³ï¼‰</p>
      </div>
      <div class="correlation-item">
        <h4>è§„å¾‹æ€§</h4>
        <p>å›ºå®šä½œæ¯ä¸ç¡çœ è´¨é‡ï¼š</p>
        <ul>
          <li>æ·±åº¦ç¡çœ å¢åŠ 20%</li>
          <li>å°±å¯æ—¶é—´ç¼©çŸ­10åˆ†é’Ÿ</li>
        </ul>
        <p>ç›¸å…³æ€§ï¼š0.85ï¼ˆå¼ºï¼‰</p>
      </div>
    </div>

    <h4>ç¯å¢ƒå› ç´ </h4>
    <div class="correlation-grid">
      <div class="correlation-item">
        <h4>æ¸©åº¦æ§åˆ¶</h4>
        <p>æœ€ä½³æ¸©åº¦èŒƒå›´20-22Â°Cï¼š</p>
        <ul>
          <li>æ·±åº¦ç¡çœ å¢åŠ 8%</li>
          <li>ç¿»èº«æ¬¡æ•°å‡å°‘25%</li>
        </ul>
        <p>ç›¸å…³æ€§ï¼š0.71ï¼ˆå¼ºï¼‰</p>
      </div>
      <div class="correlation-item">
        <h4>å…‰ç…§æš´éœ²</h4>
        <p>é»‘æš—ç¯å¢ƒçš„å½±å“ï¼š</p>
        <ul>
          <li>å…¥ç¡é€Ÿåº¦æé«˜30%</li>
          <li>ç¡çœ è´¨é‡æ”¹å–„15%</li>
        </ul>
        <p>ç›¸å…³æ€§ï¼š0.68ï¼ˆä¸­åº¦ï¼‰</p>
      </div>
      <div class="correlation-item">
        <h4>å™ªéŸ³æ§åˆ¶</h4>
        <p>å®‰é™ç¯å¢ƒï¼ˆ<30 dBï¼‰ï¼š</p>
        <ul>
          <li>æ·±åº¦ç¡çœ å¢åŠ 12%</li>
          <li>ç¡çœ ä¸­æ–­å‡å°‘40%</li>
        </ul>
        <p>ç›¸å…³æ€§ï¼š-0.75ï¼ˆå¼ºè´Ÿç›¸å…³ï¼‰</p>
      </div>
      <div class="correlation-item">
        <h4>ç©ºæ°”è´¨é‡</h4>
        <p>è‰¯å¥½é€šé£ç¯å¢ƒï¼š</p>
        <ul>
          <li>è¡€æ°§é¥±å’Œåº¦æé«˜2%</li>
          <li>ç¡çœ è´¨é‡æ”¹å–„10%</li>
        </ul>
        <p>ç›¸å…³æ€§ï¼š0.62ï¼ˆä¸­åº¦ï¼‰</p>
      </div>
    </div>

    <h4>å‘¨æœŸæ€§è¶‹åŠ¿</h4>
    <div class="correlation-grid">
      <div class="correlation-item">
        <h4>å·¥ä½œæ—¥ä¸å‘¨æœ«</h4>
        <p>å‘¨æœ«ç¡çœ ç‰¹ç‚¹ï¼š</p>
        <ul>
          <li>ç¡çœ æ—¶é•¿å¢åŠ 1.2å°æ—¶</li>
          <li>æ·±åº¦ç¡çœ æ”¹å–„15%</li>
        </ul>
      </div>
      <div class="correlation-item">
        <h4>å­£èŠ‚å˜åŒ–</h4>
        <p>å½“å‰å­£èŠ‚ç‰¹å¾ï¼š</p>
        <ul>
          <li>ä¸æ˜¥å­£/ç§‹å­£ç›¸æ¯”ï¼Œç¡çœ æ—¶é•¿å‡å°‘0.5å°æ—¶</li>
          <li>å°±å¯æ—¶é—´å»¶è¿Ÿ30åˆ†é’Ÿ</li>
        </ul>
      </div>
    </div>
  </div>

  <div id="sleep-quality-modal" class="chart-modal">
    <div class="chart-modal-content">
      <span class="close-modal" onclick="hideDetailModal('sleep-quality')">&times;</span>
      <h3>è¯¦ç»†ç¡çœ è´¨é‡è¶‹åŠ¿</h3>
      
      <div class="chart-controls">
        <button class="trend-toggle active" data-trend="all">æ‰€æœ‰è¶‹åŠ¿</button>
        <button class="trend-toggle" data-trend="weekly">æ¯å‘¨æ¨¡å¼</button>
        <button class="trend-toggle" data-trend="fluctuation">æ³¢åŠ¨åˆ†æ</button>
      </div>
      
      <canvas id="sleep-quality-detail"></canvas>
      
      <div class="data-interaction">
        <h4>æ•°æ®æ ‡æ³¨</h4>
        <div class="interaction-controls">
          <button onclick="markInvalidData()">æ ‡è®°æ— æ•ˆæ•°æ®</button>
          <button onclick="addDataNote()">æ·»åŠ å¤‡æ³¨</button>
        </div>
        <div class="data-notes">
          <h5>æ•°æ®å¤‡æ³¨</h5>
          <div id="notes-container"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function calculateTrendLine(data) {
  const n = data.length;
  let sumX = 0;
  let sumY = 0;
  let sumXY = 0;
  let sumXX = 0;

  for (let i = 0; i < n; i++) {
    sumX += i;
    sumY += data[i];
    sumXY += i * data[i];
    sumXX += i * i;
  }

  const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
  const intercept = (sumY - slope * sumX) / n;

  return data.map((_, i) => slope * i + intercept);
}

function calculateWeeklyPattern(data) {
  const movingAverage = [];
  const windowSize = 7;

  for (let i = 0; i < data.length; i++) {
    if (i < windowSize - 1) {
      movingAverage.push(null);
      continue;
    }

    let sum = 0;
    for (let j = 0; j < windowSize; j++) {
      sum += data[i - j];
    }
    movingAverage.push(sum / windowSize);
  }

  return movingAverage;
}

function getNoteForData(index) {
  const notes = JSON.parse(localStorage.getItem('dataNotes') || '{}');
  return notes[index] || '';
}

function showDataInteractionMenu(dataIndex) {
  console.log(`Showing interaction menu for data point ${dataIndex}`);
}

function markInvalidData(index) {
  const invalidData = JSON.parse(localStorage.getItem('invalidData') || '[]');
  invalidData.push(index);
  localStorage.setItem('invalidData', JSON.stringify(invalidData));
  
  const chart = detailCharts['sleep-quality-detail'];
  if (chart) {
    chart.data.datasets[0].pointBackgroundColor = chart.data.datasets[0].data.map((_, i) => 
      invalidData.includes(i) ? 'rgba(200, 200, 200, 0.5)' : 'rgba(72, 161, 195, 1)'
    );
    chart.update();
  }
  
  addDataNote(`æ•°æ®ç‚¹ ${index + 1} è¢«æ ‡è®°ä¸ºæ— æ•ˆ`);
}

function addDataNote() {
  const note = prompt('è¯·è¾“å…¥æ•°æ®å¤‡æ³¨:');
  if (note) {
    const notes = JSON.parse(localStorage.getItem('dataNotes') || '{}');
    const selectedPoint = detailCharts['sleep-quality-detail'].getActiveElements()[0];
    
    if (selectedPoint) {
      const index = selectedPoint.index;
      notes[index] = note;
      localStorage.setItem('dataNotes', JSON.stringify(notes));
      
      const notesContainer = document.getElementById('notes-container');
      const noteElement = document.createElement('div');
      noteElement.textContent = `æ•°æ®ç‚¹ ${index + 1}: ${note}`;
      notesContainer.appendChild(noteElement);
    }
  }
}

let detailCharts = {};

function createDetailChart(canvasId, data) {
  if (detailCharts[canvasId]) {
    detailCharts[canvasId].destroy();
  }

  const ctx = document.getElementById(canvasId).getContext('2d');
  
  const values = data.datasets[0].data;
  const mean = values.reduce((a, b) => a + b, 0) / values.length;
  const stdDev = Math.sqrt(values.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / values.length);
  
  const anomalyPoints = values.map((val, idx) => {
    return Math.abs(val - mean) > 2 * stdDev ? {
      x: idx,
      y: val
    } : null;
  }).filter(point => point !== null);

  const trendLine = calculateTrendLine(data.datasets[0].data);
  const weeklyPattern = calculateWeeklyPattern(data.datasets[0].data);
  
  const newChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.labels,
      datasets: [
        {
          label: 'ç¡çœ è´¨é‡å¾—åˆ†',
          data: data.datasets[0].data,
          borderColor: 'var(--secondary)',
          backgroundColor: 'rgba(72, 161, 195, 0.1)',
          fill: true
        },
        {
          label: 'æ•´ä½“è¶‹åŠ¿',
          data: trendLine,
          borderColor: 'rgba(255, 99, 132, 0.8)',
          borderDash: [5, 5],
          fill: false,
          hidden: true
        },
        {
          label: 'å‘¨æœŸæ€§è¶‹åŠ¿',
          data: weeklyPattern,
          borderColor: 'rgba(75, 192, 192, 0.8)',
          borderDash: [3, 3],
          fill: false,
          hidden: true
        },
        {
          label: 'å¼‚å¸¸å€¼',
          data: anomalyPoints,
          type: 'scatter',
          pointStyle: 'circle',
          pointRadius: 8,
          pointBackgroundColor: 'rgba(255, 0, 0, 0.5)',
          pointBorderColor: 'red',
          pointBorderWidth: 2,
          showLine: false
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        tooltip: {
          callbacks: {
            afterBody: function(context) {
              const idx = context[0].dataIndex;
              const val = data.datasets[0].data[idx];
              const note = getNoteForData(idx);
              let tooltipText = '';
              
              if (Math.abs(val - mean) > 2 * stdDev) {
                tooltipText += `\nâš ï¸ å¯èƒ½æ˜¯å¼‚å¸¸å€¼\nåç¦»å‡å€¼: ${(val - mean).toFixed(2)}`;
              }
              if (note) {
                tooltipText += `\nğŸ“ å¤‡æ³¨: ${note}`;
              }
              return tooltipText;
            }
          }
        },
        title: {
          display: true,
          text: 'è¿‡å»ä¸€å‘¨ç¡çœ è¶‹åŠ¿',
          font: {
            size: 16
          }
        }
      },
      onClick: function(event, elements) {
        if (elements.length > 0) {
          const idx = elements[0].index;
          const val = data.datasets[0].data[idx];
          if (Math.abs(val - mean) > 2 * stdDev) {
            if (confirm('è¯¥æ•°æ®ç‚¹å¯èƒ½æ˜¯å¼‚å¸¸å€¼ã€‚æ‚¨æ˜¯å¦è¦å°†å…¶æ ‡è®°ä¸ºæ— æ•ˆæ•°æ®ï¼Ÿ')) {
              markInvalidData(idx);
            }
          }
        }
      }
    }
  });

  document.querySelectorAll('.trend-toggle').forEach(button => {
    button.addEventListener('click', function() {
      const trendType = this.dataset.trend;
      
      document.querySelectorAll('.trend-toggle').forEach(btn => {
        btn.classList.remove('active');
      });
      
      this.classList.add('active');
      
      if (trendType === 'all') {
        newChart.show(1);
        newChart.show(2);
      } else if (trendType === 'weekly') {
        newChart.hide(1);
        newChart.show(2);
      } else if (trendType === 'fluctuation') {
        newChart.show(1);
        newChart.hide(2);
      }
      
      newChart.update();
    });
  });

  detailCharts[canvasId] = newChart;
  return newChart;
}

function showDetailModal(modalId) {
  const modal = document.getElementById(`${modalId}-modal`);
  if (!modal) {
    console.error(`Modal with id ${modalId}-modal not found`);
    return;
  }
  
  modal.style.display = 'flex';

  const canvas = document.getElementById(`${modalId}-detail`);
  if (!canvas) {
    console.error(`Canvas with id ${modalId}-detail not found`);
    return;
  }

  const sampleData = {
    labels: Array.from({length: 30}, (_, i) => `ç¬¬ ${i + 1} å¤©`),
    datasets: [{
      data: Array.from({length: 30}, () => 70 + Math.random() * 20)
    }]
  };

  createDetailChart(`${modalId}-detail`, sampleData);
}

function hideDetailModal(modalId) {
  const modal = document.getElementById(`${modalId}-modal`);
  modal.style.display = 'none';

  if (detailCharts[`${modalId}-detail`]) {
    detailCharts[`${modalId}-detail`].destroy();
    delete detailCharts[`${modalId}-detail`];
  }
}

const ctx = document.getElementById('sleepTrendChart').getContext('2d');
new Chart(ctx, {
    type: 'line',
    data: {
        labels: ['7å¤©å‰', '6å¤©å‰', '5å¤©å‰', '4å¤©å‰', '3å¤©å‰', '2å¤©å‰', 'æ˜¨å¤©'],
        datasets: [{
            label: 'ç¡çœ æ—¶é•¿ï¼ˆå°æ—¶ï¼‰',
            data: [7.2, 6.8, 7.5, 7.1, 7.3, 7.6, 7.4],
            borderColor: 'var(--secondary)',
            backgroundColor: 'rgba(72, 161, 195, 0.1)',
            tension: 0.4,
            fill: true
        }]
    },
    options: {
        responsive: true,
        plugins: {
            title: {
                display: true,
                text: 'è¿‡å»ä¸€å‘¨ç¡çœ è¶‹åŠ¿',
                font: {
                    size: 16
                }
            },
            legend: {
                display: true,
                position: 'top'
            }
        },
        scales: {
            y: {
                beginAtZero: false,
                min: 6,
                max: 9,
                ticks: {
                    stepSize: 0.5
                }
            }
        },
        interaction: {
            intersect: false,
            mode: 'index'
        }
    }
});

const observerOptions = {
    threshold: 0.1
};

const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
        if (entry.isIntersecting) {
            entry.target.style.opacity = "1";
            entry.target.style.transform = "translateY(0)";
        }
    });
}, observerOptions);

document.querySelectorAll('.fade-in').forEach(element => {
    observer.observe(element);
});

function highlightPrepSections() {
  const sections = document.querySelectorAll('.prep-section');
  sections.forEach(section => {
    section.addEventListener('mouseenter', () => {
      section.style.transform = 'scale(1.01)';
      section.style.transition = 'transform 0.3s ease';
    });
    
    section.addEventListener('mouseleave', () => {
      section.style.transform = 'scale(1)';
    });
  });
}

// Call after DOM loads
document.addEventListener('DOMContentLoaded', highlightPrepSections);

// Add animation for success highlights
document.querySelectorAll('.success-highlight').forEach(element => {
  element.addEventListener('mouseenter', () => {
    element.style.transform = 'scale(1.02)';
    element.style.transition = 'transform 0.3s ease';
  });
  
  element.addEventListener('mouseleave', () => {
    element.style.transform = 'scale(1)';
  });
});
</script>

</body></html>